# ğŸš€ ìë™ ë¦´ë¦¬ìŠ¤ ì›Œí¬í”Œë¡œìš°
name: Auto Release

on:
  # ë§¤ì¼ ìì •ì— ìë™ ë¦´ë¦¬ìŠ¤ ì²´í¬
  schedule:
    - cron: '0 0 * * *'
  # ìˆ˜ë™ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      create_release:
        description: 'Create GitHub release'
        required: true
        default: true
        type: boolean

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.changes.outputs.has_changes }}
      new_version: ${{ steps.version.outputs.new_version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check for changes since last release
      id: changes
      run: |
        # ë§ˆì§€ë§‰ ë¦´ë¦¬ìŠ¤ íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Last tag: $LAST_TAG"
        
        # ë§ˆì§€ë§‰ ë¦´ë¦¬ìŠ¤ ì´í›„ ì»¤ë°‹ ìˆ˜ í™•ì¸
        COMMITS_SINCE=$(git rev-list ${LAST_TAG}..HEAD --count)
        echo "Commits since last release: $COMMITS_SINCE"
        
        if [ "$COMMITS_SINCE" -gt 0 ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Setup Node.js
      if: steps.changes.outputs.has_changes == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Calculate new version
      if: steps.changes.outputs.has_changes == 'true'
      id: version
      run: |
        # package.jsonì—ì„œ í˜„ì¬ ë²„ì „ ì½ê¸°
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Current version: $CURRENT_VERSION"
        
        # ë²„ì „ íƒ€ì… ê²°ì •
        VERSION_TYPE="${{ github.event.inputs.version_type || 'patch' }}"
        
        # ìƒˆ ë²„ì „ ê³„ì‚°
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}
        
        case $VERSION_TYPE in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch)
            PATCH=$((PATCH + 1))
            ;;
        esac
        
        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        echo "New version: $NEW_VERSION"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

  build-and-release:
    needs: check-changes
    if: needs.check-changes.outputs.has_changes == 'true'
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Update version
      run: |
        NEW_VERSION="${{ needs.check-changes.outputs.new_version }}"
        npm version $NEW_VERSION --no-git-tag-version
        cd desktop && npm version $NEW_VERSION --no-git-tag-version
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build web app
      run: npm run build
      
    - name: Install desktop dependencies
      run: |
        cd desktop
        npm ci
        
    - name: Build Windows
      if: matrix.os == 'windows-latest'
      run: |
        cd desktop
        npm run build:windows
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build macOS
      if: matrix.os == 'macos-latest'
      run: |
        cd desktop
        npm run build:mac
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd desktop
        npm run build:linux
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os }}-build
        path: desktop/dist/*
        retention-days: 30

  create-release:
    needs: [check-changes, build-and-release]
    runs-on: ubuntu-latest
    if: needs.check-changes.outputs.has_changes == 'true' && (github.event.inputs.create_release != 'false')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        
    - name: Organize artifacts
      run: |
        mkdir -p release
        
        # Windows íŒŒì¼ë“¤
        find artifacts/windows-latest-build -name "*.exe" -exec cp {} release/ \;
        find artifacts/windows-latest-build -name "*.nsis.7z" -exec cp {} release/ \; 2>/dev/null || true
        
        # macOS íŒŒì¼ë“¤
        find artifacts/macos-latest-build -name "*.dmg" -exec cp {} release/ \;
        
        # Linux íŒŒì¼ë“¤
        find artifacts/ubuntu-latest-build -name "*.AppImage" -exec cp {} release/ \;
        
        echo "Release files:"
        ls -la release/
        
    - name: Generate changelog
      id: changelog
      run: |
        NEW_VERSION="${{ needs.check-changes.outputs.new_version }}"
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        
        echo "## ğŸš€ Workflow Visualizer v$NEW_VERSION" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ìƒˆë¡œìš´ ê¸°ëŠ¥ ë° ê°œì„ ì‚¬í•­" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        # ë§ˆì§€ë§‰ ë¦´ë¦¬ìŠ¤ ì´í›„ì˜ ì»¤ë°‹ ë©”ì‹œì§€ë“¤
        git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges >> CHANGELOG.md
        
        echo "" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ“¥ ë‹¤ìš´ë¡œë“œ" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- **Windows**: \`.exe\` íŒŒì¼ ë‹¤ìš´ë¡œë“œ" >> CHANGELOG.md
        echo "- **macOS**: \`.dmg\` íŒŒì¼ ë‹¤ìš´ë¡œë“œ" >> CHANGELOG.md
        echo "- **Linux**: \`.AppImage\` íŒŒì¼ ë‹¤ìš´ë¡œë“œ" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ”‘ ë¼ì´ì„¼ìŠ¤ í™œì„±í™”" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "1. [Gumroadì—ì„œ ì›” \$9.9 êµ¬ë…](https://halowf.com/pricing)" >> CHANGELOG.md
        echo "2. ì´ë©”ì¼ë¡œ ë°›ì€ ë¼ì´ì„¼ìŠ¤ í‚¤ ì…ë ¥" >> CHANGELOG.md
        echo "3. ëª¨ë“  ê³ ê¸‰ ê¸°ëŠ¥ í™œì„±í™”!" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ’° í¬í•¨ ê¸°ëŠ¥" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- âœ… ë¬´ì œí•œ í”„ë¡œì íŠ¸ ë¶„ì„" >> CHANGELOG.md
        echo "- âœ… ë¬´ì œí•œ íŒŒì¼ í¬ê¸°" >> CHANGELOG.md
        echo "- âœ… ëª¨ë“  AI ë¶„ì„ ê¸°ëŠ¥" >> CHANGELOG.md
        echo "- âœ… ë¡œì»¬ ì„¤ì¹˜ ë° ì‚¬ìš©" >> CHANGELOG.md
        echo "- âœ… ì—…ë°ì´íŠ¸ ë° ê¸°ìˆ  ì§€ì›" >> CHANGELOG.md
        echo "- âœ… 5ê°œ ì–¸ì–´ ì§€ì› (í•œêµ­ì–´, ì˜ì–´, ì¼ë³¸ì–´, ì¤‘êµ­ì–´, ìŠ¤í˜ì¸ì–´)" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### ğŸ“‹ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- **Windows**: 10/11 (64-bit)" >> CHANGELOG.md
        echo "- **macOS**: 10.15 ì´ìƒ (Intel/Apple Silicon)" >> CHANGELOG.md
        echo "- **Linux**: Ubuntu 18.04+ ë˜ëŠ” í˜¸í™˜ ë°°í¬íŒ" >> CHANGELOG.md
        echo "- **RAM**: ìµœì†Œ 4GB ê¶Œì¥" >> CHANGELOG.md
        echo "- **ì €ì¥ê³µê°„**: 1GB ì´ìƒ" >> CHANGELOG.md
        
        # ë³€ê²½ë¡œê·¸ë¥¼ ì¶œë ¥ ë³€ìˆ˜ë¡œ ì„¤ì •
        CHANGELOG_CONTENT=$(cat CHANGELOG.md)
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create Git tag
      run: |
        NEW_VERSION="v${{ needs.check-changes.outputs.new_version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a $NEW_VERSION -m "Release $NEW_VERSION"
        git push origin $NEW_VERSION
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ needs.check-changes.outputs.new_version }}"
        name: "Workflow Visualizer v${{ needs.check-changes.outputs.new_version }}"
        body: ${{ steps.changelog.outputs.changelog }}
        files: release/*
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Notify Discord (Optional)
      if: env.DISCORD_WEBHOOK_URL
      run: |
        curl -H "Content-Type: application/json" \
             -X POST \
             -d '{
               "content": "ğŸš€ **ìƒˆ ë¦´ë¦¬ìŠ¤ ì¶œì‹œ!**\n\n**Workflow Visualizer v${{ needs.check-changes.outputs.new_version }}**\n\nğŸ“¥ ë‹¤ìš´ë¡œë“œ: https://github.com/peterkingsmesn/workflow-visualizer/releases/latest\nğŸ’° êµ¬ë…: https://halowf.com/pricing"
             }' \
             ${{ env.DISCORD_WEBHOOK_URL }}
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

  update-download-links:
    needs: [check-changes, create-release]
    runs-on: ubuntu-latest
    if: needs.check-changes.outputs.has_changes == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Update download page
      run: |
        NEW_VERSION="v${{ needs.check-changes.outputs.new_version }}"
        
        # DownloadSection.tsx ì—…ë°ì´íŠ¸
        sed -i "s/releases\/latest/releases\/tag\/$NEW_VERSION/g" src/components/landing/DownloadSection.tsx
        
        # README.md ì—…ë°ì´íŠ¸ (ìˆë‹¤ë©´)
        if [ -f README.md ]; then
          sed -i "s/releases\/latest/releases\/tag\/$NEW_VERSION/g" README.md
        fi
        
    - name: Commit and push updates
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "docs: update download links to v${{ needs.check-changes.outputs.new_version }}" || exit 0
        git push